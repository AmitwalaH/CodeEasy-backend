{
  "language": "csharp",
  "slug": "object-relational-mapping",
  "docs": {
    "introduction": "# Introduction\r\n\r\n## Resource Cleanup\r\n\r\nIf a class implements the `IDisposable` interface then its `Dispose()` method must be called whenever an instance is no longer required. This is typically done from a `catch` or `finally` clause or from the `Dispose()` routine of some caller. `Dispose()` provides an opportunity for unmanaged resources such as operating system objects (which are not managed by the .NET runtime) to be released and the internal state of managed resources to be reset.\r\n",
    "instructions": "# Instructions\r\n\r\nYou are implementing an ORM (Object Relational Mapping) system over a database which has been provided by another team.\r\n\r\nThe database is capable of handling a single transaction at one time.\r\n\r\nNo logging or other error handling is required at this stage.\r\n\r\nNote that, internally, the database transitions through a number of state: Closed, TransactionStarted, DataWritten, Invalid, Closed. You can rely on the fact that the database is in a `Closed` state at the start of each exercise.\r\n\r\nThe database has the following instance methods:\r\n\r\n- `Database.BeginTransaction()` starts a transaction on the database. If this is called when the database is not in a `Closed` state then an exception is thrown. If successful the internal state of the database will change to `TransactionStarted`.\r\n- `Database.Write(string data)` writes data to the database within the transaction. If it receives bad data an exception will be thrown. An attempt to call this method without `BeginTransaction()` having been called will cause an exception to be thrown. If successful the internal state of the database will change to `DataWritten`.\r\n- `Database.EndTransaction()` commits the transaction to the database. It may throw an exception if it can't close the transaction or if `Database.BeginTransaction()` had not been called.\r\n- A call to`Database.Dispose()` will clean up the database if an exception is thrown during a transaction. This will change the state of the database to `Closed`.\r\n\r\nThe state of the database can be accessed using `database.DbState`.\r\n\r\nThe state of the database can be set to one of:\r\n\r\n- TransactionStarted\r\n- DataWritten\r\n- Invalid\r\n- Closed\r\n\r\n## 1. Begin a transaction\r\n\r\nImplement `Orm.Begin()` to start a transaction on the database. If the database does not start with an internal state of `State.Closed` then it throws an `InvalidOperationException`.\r\n\r\n```csharp\r\nvar orm = new Orm(new Database());\r\norm.Begin();\r\n// => database has an internal state of State.TransactionStarted\r\n```\r\n\r\n## 2. Write some data to the database\r\n\r\nImplement `Orm.Write()` to write some data to the database. If the database does not start with an internal state of `State.TransactionStarted` or bad data is written then an `InvalidOperationException` is thrown. If the write fails then the `Orm` must clean up the database.\r\n\r\n```csharp\r\nvar orm = new Orm(new Database());\r\norm.Begin();\r\norm.Write(\"some data\");\r\n// => database has an internal state of State.DataWritten\r\norm.Write(\"bad write\");\r\n// => database has an internal state of State.Closed\r\n```\r\n\r\n## 3. Commit previously written data to the database\r\n\r\nImplement `Orm.Commit()` to commit the data. If the commit fails then clean up the database. If the database does not start with an internal state of `State.DataWritten` then an `InvalidOperationException` is thrown.\r\n\r\n```csharp\r\nvar orm = new Orm(new Database());\r\norm.Begin();\r\norm.Write(\"some data\");\r\norm.Commit();\r\n// => database has an internal state of State.Closed\r\norm.Begin();\r\norm.Write(\"bad commit\");\r\norm.Commit();\r\n// => database has an internal state of State.Closed\r\n```\r\n\r\n## 4. Ensure that the database is cleaned up correctly if the ORM has to close part way through a transaction.\r\n\r\nImplement the `IDisposable` interface on the `Orm` class. The call is guaranteed to succeed.\r\n\r\n```csharp\r\nvar db = new Database();\r\nvar orm = new Orm(db);\r\norm.Begin();\r\norm.Write(\"some data\");\r\norm.Dispose();\r\n// => database has an internal state of State.Closed\r\n```\r\n",
    "hints": "# Hints\r\n\r\n## General\r\n\r\nDocumentation related to `IDisposable` is [here][idisposable]\r\n\r\n## 2. Write some data to the database\r\n\r\n[`try`/`catch`][try-catch-finally] is necessary to ensure that the database is restored to its `Closed` state if an exception is thrown because of bad data.\r\n\r\n## 3. Commit previously written data to the database\r\n\r\n[`try`/`catch`][try-catch-finally] is necessary to ensure that the database is restored to its `Closed` state if an exception is thrown because of bad data.\r\n\r\n[idisposable]: https://docs.microsoft.com/en-us/dotnet/api/system.idisposable\r\n[try-catch-finally]: https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/try-catch-finally\r\n"
  },
  "starter_code": {
    "Database.cs": "public class Database : IDisposable\r\n{\r\n    public enum State { TransactionStarted, DataWritten, Invalid, Closed }\r\n\r\n    public State DbState { get; private set; } = State.Closed;\r\n    public string lastData = string.Empty;\r\n\r\n    public void BeginTransaction()\r\n    {\r\n        if (DbState != State.Closed)\r\n        {\r\n            throw new InvalidOperationException();\r\n        }\r\n        DbState = State.TransactionStarted;\r\n    }\r\n\r\n    public void Write(string data)\r\n    {\r\n        if (DbState != State.TransactionStarted)\r\n        {\r\n            throw new InvalidOperationException();\r\n        }\r\n        // this does something significant with the db transaction object\r\n        lastData = data;\r\n        if (data == \"bad write\")\r\n        {\r\n            DbState = State.Invalid;\r\n            throw new InvalidOperationException();\r\n        }\r\n\r\n        DbState = State.DataWritten;\r\n    }\r\n\r\n    public void EndTransaction()\r\n    {\r\n        if (DbState != State.DataWritten && DbState != State.TransactionStarted)\r\n        {\r\n            throw new InvalidOperationException();\r\n        }\r\n        // this does something significant to end the db transaction object\r\n        if (lastData == \"bad commit\")\r\n        {\r\n            DbState = State.Invalid;\r\n            throw new InvalidOperationException();\r\n        }\r\n\r\n        DbState = State.Closed;\r\n    }\r\n\r\n    public void Dispose()\r\n    {\r\n        DbState = State.Closed;\r\n    }\r\n}\r\n",
    "ObjectRelationalMapping.cs": "public class Orm\r\n{\r\n    private Database database;\r\n\r\n    public Orm(Database database)\r\n    {\r\n        this.database = database;\r\n    }\r\n\r\n    public void Begin()\r\n    {\r\n        throw new NotImplementedException($\"Please implement the Orm.Begin() method\");\r\n    }\r\n\r\n    public void Write(string data)\r\n    {\r\n        throw new NotImplementedException($\"Please implement the Orm.Write() method\");\r\n    }\r\n\r\n    public void Commit()\r\n    {\r\n        throw new NotImplementedException($\"Please implement the Orm.Commit() method\");\r\n    }\r\n}\r\n"
  },
  "tests": {
    "ObjectRelationalMappingTests.cs": "using Exercism.Tests;\r\n\r\npublic class ObjectRelationalMappingTests\r\n{\r\n    [Fact]\r\n    [Task(2)]\r\n    public void Write_good()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        orm.Begin();\r\n        orm.Write(\"good write\");\r\n        object[] actual = { db.DbState, db.lastData };\r\n        Assert.Equal(new object[] { Database.State.DataWritten, \"good write\" }, actual);\r\n    }\r\n\r\n    [Fact]\r\n    [Task(2)]\r\n    public void Write_bad()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        orm.Begin();\r\n        orm.Write(\"bad write\");\r\n        object[] actual = { db.DbState, db.lastData };\r\n        Assert.Equal(new object[] { Database.State.Closed, \"bad write\" }, actual);\r\n    }\r\n\r\n    [Fact]\r\n    [Task(3)]\r\n    public void Commit_good()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        orm.Begin();\r\n        orm.Write(\"good commit\");\r\n        orm.Commit();\r\n        object[] actual = { db.DbState, db.lastData };\r\n        Assert.Equal(new object[] { Database.State.Closed, \"good commit\" }, actual);\r\n    }\r\n\r\n    [Fact]\r\n    [Task(3)]\r\n    public void Commit_bad()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        orm.Begin();\r\n        orm.Write(\"bad commit\");\r\n        orm.Commit();\r\n        object[] actual = { db.DbState, db.lastData };\r\n        Assert.Equal(new object[] { Database.State.Closed, \"bad commit\" }, actual);\r\n    }\r\n\r\n    [Fact]\r\n    [Task(3)]\r\n    public void Out_of_order()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        orm.Write(\"bad commit\");\r\n        orm.Commit();\r\n        object[] actual = { db.DbState, db.lastData };\r\n        Assert.Equal(new object[] { Database.State.Closed, string.Empty }, actual);\r\n    }\r\n\r\n    [Fact]\r\n    [Task(4)]\r\n    public void Disposable()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        orm.Begin();\r\n        orm.Write(\"good data\");\r\n        var disposable = Assert.IsAssignableFrom<IDisposable>(orm);\r\n        disposable.Dispose();\r\n        object[] actual = { db.DbState, db.lastData };\r\n        Assert.Equal(new object[] { Database.State.Closed, \"good data\" }, actual);\r\n    }\r\n}\r\n\r\n"
  }
}