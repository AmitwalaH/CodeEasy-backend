{
  "language": "csharp",
  "slug": "orm-in-one-go",
  "docs": {
    "introduction": "# Introduction\r\n\r\n## Resource Lifetime\r\n\r\n[concept:csharp/resource-cleanup]() uses the `IDispose` interface to signal that some object's resource or other program state needed to be released or reset when the object was no longer required (and that relying on the garbage collector would not achieve this or provide the required level of control) and that `IDisposable.Dispose()` method was the natural place for such cleanup operations.\r\n\r\nThere is another construct, the `using` block, that enables, from the caller's perspective, all the resource lifetime management to be gathered into a single statement.\r\n\r\n```csharp\r\nusing (var file = new File(\"my_secrets\"))\r\n{\r\n    file.WriteSecret(\"xxxxxxx\");\r\n}\r\n```\r\n\r\nIn the above example the file system resources associated with `file` will be released back to the operating system when the `using` block is exited.\r\n\r\nFor the pattern to work the variable in the using statement must be a reference type that implements the `IDisposable` interface and must release resources/reset program state in its `Dispose()` method.\r\n\r\nC# 8 introduces a refinement to the pattern. A using statement can placed at the beginning of a block.\r\n\r\n```csharp\r\nusing var drawingResource = some_provided_or_new_object;\r\ntry\r\n{\r\n    drawingResource.DrawSomething();\r\n}\r\ncatch (Exception)\r\n{\r\n    throw;\r\n}\r\n```\r\n\r\nJava developers may recognize this as an analog of the _automatic resource management_ mechanism introduced in Java 7.\r\n",
    "instructions": "# Instructions\r\n\r\nYou are back working on the ORM (Object Relationship Mapping) system introduced in [exercise:csharp/object-relational-mapping]().\r\n\r\nOur ORM usage analysis shows that 95% of transactions are executed from within one calling method, and it has been decided that it would be more appropriate to have a single ORM method that opened, wrote and committed a transaction.\r\n\r\nThe database has the following instance methods:\r\n\r\n- `Database.BeginTransaction()` starts a transaction on the database.\r\n- `Database.Write(string data)` writes data to the database within the transaction. If it receives bad data an exception will be thrown. An attempt to call this method without `BeginTransaction()` having been called will cause an exception to be thrown. If successful the internal state of the database will change to `DataWritten`.\r\n- `Database.EndTransaction()` commits the transaction to the database. It may throw an exception if it can't close the transaction or if `Database.BeginTransaction()` had not been called.\r\n- A call to`Database.Dispose()` will clean up the database if an exception is thrown during a transaction. This will change the state of the database to `Closed`.\r\n\r\n## 1. Write to the database\r\n\r\nImplement the `Orm.Write()` method to begin a database transaction, write the data passed in and commit the transaction. All exceptions including `InvalidOperationException` should be allowed to pass to the caller without logging or any other intervention.\r\n\r\n```csharp\r\nDatabase db = new Database();\r\nOrm orm = new Orm(db);\r\norm.Write(\"good write\");\r\n// => database has an internal state of State.Closed\r\norm.Write(\"bad write\");\r\n// => an exception is thrown but database is left with an internal state of State.Closed\r\norm.Write(\"bad commit\");\r\n// => an exception is thrown but database is left with an internal state of State.Closed\r\n```\r\n\r\n## 2. Write to the database and return an indication of whether the write was successful to the caller\r\n\r\nIt has been a few months since `Orm.Write()` was introduced and there is division in the team. Many developers would like the _ORM_ to handle errors when exceptions are thrown and simply return an indication of success to the caller.\r\n\r\nPlease implement the `Orm.WriteSafely()` method to begin a database transaction, write the data passed in and commit the transaction (as above). It should return `true` if the _write_ was successful, otherwise `false`. Do not attempt to log the exception.\r\n\r\n```csharp\r\nDatabase db = new Database();\r\nOrm orm = new Orm(db);\r\norm.WriteSafely(\"good write\");\r\n// => true\r\norm.WriteSafely(\"bad write\");\r\n// => false\r\norm.WriteSafely(\"bad commit\");\r\n// => false\r\n```\r\n",
    "hints": "# Hints\r\n\r\n## General\r\n\r\n- [using statement][using-statement] documentation describes how and when to use the `using` keyword.\r\n\r\n## 1. Write to the database\r\n\r\n- Consider the various methods on the database, and the states that the database transitions to with each one.\r\n\r\n## 2. Write to the database and return an indication to the caller of whether the write operation was successful\r\n\r\n- Use of [`exceptions`][try-catch] is necessary in this case.\r\n\r\n[using-statement]: https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/using-statement\r\n[try-catch]: https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/try-catch\r\n"
  },
  "starter_code": {
    "OrmInOneGo.cs": "public class Orm\r\n{\r\n    private Database database;\r\n\r\n    public Orm(Database database)\r\n    {\r\n        this.database = database;\r\n    }\r\n\r\n    public void Write(string data)\r\n    {\r\n        throw new NotImplementedException($\"Please implement the Orm.Write() method\");\r\n    }\r\n\r\n    public bool WriteSafely(string data)\r\n    {\r\n        throw new NotImplementedException($\"Please implement the Orm.WriteSafely() method\");\r\n    }\r\n}\r\n"
  },
  "tests": {
    "OrmInOneGoTests.cs": "using Exercism.Tests;\r\n\r\npublic class OrmInOneGoTests\r\n{\r\n    enum Exception\r\n    {\r\n        InvalidOperationExceptionThrown,\r\n        NoInvalidOperationExceptionThrown\r\n    }\r\n    [Fact]\r\n    [Task(1)]\r\n    public void Write_good()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        orm.Write(\"good write\");\r\n        Assert.Equal((Database.State.Closed, \"good write\"),\r\n            (Database.DbState, Database.lastData));\r\n    }\r\n\r\n    [Fact]\r\n    [Task(1)]\r\n    public void Write_bad()\r\n    {\r\n        Exception result = Exception.NoInvalidOperationExceptionThrown;\r\n        try\r\n        {\r\n            var db = new Database();\r\n            var orm = new Orm(db);\r\n            orm.Write(\"bad write\");\r\n        }\r\n        catch (InvalidOperationException)\r\n        {\r\n            result = Exception.InvalidOperationExceptionThrown;\r\n        }\r\n        Assert.Equal((Exception.InvalidOperationExceptionThrown, Database.State.Closed, \"bad write\"),\r\n            (result, Database.DbState, Database.lastData));\r\n    }\r\n\r\n    [Fact]\r\n    [Task(1)]\r\n    public void Commit_bad()\r\n    {\r\n        Exception result = Exception.NoInvalidOperationExceptionThrown;\r\n        try\r\n        {\r\n            var db = new Database();\r\n            var orm = new Orm(db);\r\n            orm.Write(\"bad commit\");\r\n        }\r\n        catch (InvalidOperationException)\r\n        {\r\n            result = Exception.InvalidOperationExceptionThrown;\r\n        }\r\n        Assert.Equal((Exception.InvalidOperationExceptionThrown, Database.State.Closed, \"bad commit\"),\r\n            (result, Database.DbState, Database.lastData));\r\n    }\r\n\r\n    [Fact]\r\n    [Task(2)]\r\n    public void CommitSafely_good()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        Assert.True(orm.WriteSafely(\"good write\"));\r\n    }\r\n\r\n    [Fact]\r\n    [Task(2)]\r\n    public void CommitSafely_bad_write()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        Assert.False(orm.WriteSafely(\"bad write\"));\r\n    }\r\n\r\n    [Fact]\r\n    [Task(2)]\r\n    public void CommitSafely_bad_commit()\r\n    {\r\n        var db = new Database();\r\n        var orm = new Orm(db);\r\n        Assert.False(orm.WriteSafely(\"bad commit\"));\r\n    }\r\n}\r\n\r\n// **** please do not modify the Database class ****\r\npublic class Database : IDisposable\r\n{\r\n    public enum State { TransactionStarted, DataWritten, Invalid, Closed }\r\n\r\n    public static State DbState { get; private set; } = State.Closed;\r\n    public static string lastData = string.Empty;\r\n\r\n    public void BeginTransaction()\r\n    {\r\n        if (DbState != State.Closed)\r\n        {\r\n            throw new InvalidOperationException();\r\n        }\r\n        DbState = State.TransactionStarted;\r\n    }\r\n\r\n    public void Write(string data)\r\n    {\r\n        if (DbState != State.TransactionStarted)\r\n        {\r\n            throw new InvalidOperationException();\r\n        }\r\n        // this does something significant with the db transaction object\r\n        lastData = data;\r\n        if (data == \"bad write\")\r\n        {\r\n            DbState = State.Invalid;\r\n            throw new InvalidOperationException();\r\n        }\r\n\r\n        DbState = State.DataWritten;\r\n    }\r\n\r\n    public void EndTransaction()\r\n    {\r\n        if (DbState != State.DataWritten && DbState != State.TransactionStarted)\r\n        {\r\n            throw new InvalidOperationException();\r\n        }\r\n        // this does something significant to end the db transaction object\r\n        if (lastData == \"bad commit\")\r\n        {\r\n            DbState = State.Invalid;\r\n            throw new InvalidOperationException();\r\n        }\r\n\r\n        DbState = State.Closed;\r\n    }\r\n\r\n    public void Dispose()\r\n    {\r\n        DbState = State.Closed;\r\n    }\r\n}\r\n\r\n"
  }
}