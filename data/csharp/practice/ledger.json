{
  "language": "csharp",
  "slug": "ledger",
  "docs": {
    "instructions": "# Instructions\r\n\r\nRefactor a ledger printer.\r\n\r\nThe ledger exercise is a refactoring exercise.\r\nThere is code that prints a nicely formatted ledger, given a locale (American or Dutch) and a currency (US dollar or euro).\r\nThe code however is rather badly written, though (somewhat surprisingly) it consistently passes the test suite.\r\n\r\nRewrite this code.\r\nRemember that in refactoring the trick is to make small steps that keep the tests passing.\r\nThat way you can always quickly go back to a working version.\r\nVersion control tools like git can help here as well.\r\n\r\nPlease keep a log of what changes you've made and make a comment on the exercise containing that log, this will help reviewers.\r\n",
    "instructions_append": "",
    "hints": ""
  },
  "starter_code": {
    "Ledger.cs": "using System.Globalization;\r\n\r\npublic class LedgerEntry\r\n{\r\n    public LedgerEntry(DateTime date, string desc, decimal chg)\r\n    {\r\n        Date = date;\r\n        Desc = desc;\r\n        Chg = chg;\r\n    }\r\n\r\n    public DateTime Date { get; }\r\n    public string Desc { get; }\r\n    public decimal Chg { get; }\r\n}\r\n\r\npublic static class Ledger\r\n{\r\n    public static LedgerEntry CreateEntry(string date, string desc, int chng)\r\n    {\r\n        return new LedgerEntry(DateTime.Parse(date, CultureInfo.InvariantCulture), desc, chng / 100.0m);\r\n    }\r\n\r\n    private static CultureInfo CreateCulture(string cur, string loc)\r\n    {\r\n        string? curSymb = null;\r\n        int curNeg = 0;\r\n        string? datPat = null;\r\n\r\n        if (cur != \"USD\" && cur != \"EUR\")\r\n        {\r\n            throw new ArgumentException(\"Invalid currency\");\r\n        }\r\n        else\r\n        {\r\n            if (loc != \"nl-NL\" && loc != \"en-US\")\r\n            {\r\n                throw new ArgumentException(\"Invalid currency\");\r\n            }\r\n\r\n            if (cur == \"USD\")\r\n            {\r\n                if (loc == \"en-US\")\r\n                {\r\n                    curSymb = \"$\";\r\n                    datPat = \"MM/dd/yyyy\";\r\n                }\r\n                else if (loc == \"nl-NL\")\r\n                {\r\n                    curSymb = \"$\";\r\n                    curNeg = 12;\r\n                    datPat = \"dd/MM/yyyy\";\r\n                }\r\n            }\r\n\r\n            if (cur == \"EUR\")\r\n            {\r\n                if (loc == \"en-US\")\r\n                {\r\n                    curSymb = \"€\";\r\n                    datPat = \"MM/dd/yyyy\";\r\n                }\r\n                else if (loc == \"nl-NL\")\r\n                {\r\n                    curSymb = \"€\";\r\n                    curNeg = 12;\r\n                    datPat = \"dd/MM/yyyy\";\r\n                }\r\n            }\r\n        }\r\n\r\n        var culture = new CultureInfo(loc, false);\r\n        culture.NumberFormat.CurrencySymbol = curSymb!;\r\n        culture.NumberFormat.CurrencyNegativePattern = curNeg;\r\n        culture.DateTimeFormat.ShortDatePattern = datPat!;\r\n        return culture;\r\n    }\r\n\r\n    private static string PrintHead(string loc)\r\n    {\r\n        if (loc == \"en-US\")\r\n        {\r\n            return \"Date       | Description               | Change       \";\r\n        }\r\n\r\n        else\r\n        {\r\n            if (loc == \"nl-NL\")\r\n            {\r\n                return \"Datum      | Omschrijving              | Verandering  \";\r\n            }\r\n            else\r\n            {\r\n                throw new ArgumentException(\"Invalid locale\");\r\n            }\r\n        }\r\n    }\r\n\r\n    private static string Date(IFormatProvider culture, DateTime date) => date.ToString(\"d\", culture);\r\n\r\n    private static string Description(string desc)\r\n    {\r\n        if (desc.Length > 25)\r\n        {\r\n            var trunc = desc.Substring(0, 22);\r\n            trunc += \"...\";\r\n            return trunc;\r\n        }\r\n\r\n        return desc;\r\n    }\r\n\r\n    private static string Change(IFormatProvider culture, decimal cgh)\r\n    {\r\n        if (cgh < 0.0m)\r\n        {\r\n            var change = cgh.ToString(\"C\", culture);\r\n            if (change.Contains(\"-\"))\r\n            {\r\n                return change + \" \";\r\n            }\r\n\r\n            return change;\r\n        }\r\n        else\r\n        {\r\n            return cgh.ToString(\"C\", culture) + \" \";\r\n        }\r\n    }\r\n\r\n    private static string PrintEntry(IFormatProvider culture, LedgerEntry entry)\r\n    {\r\n        var formatted = \"\";\r\n        var date = Date(culture, entry.Date);\r\n        var description = Description(entry.Desc);\r\n        var change = Change(culture, entry.Chg);\r\n\r\n        formatted += date;\r\n        formatted += \" | \";\r\n        formatted += string.Format(\"{0,-25}\", description);\r\n        formatted += \" | \";\r\n        formatted += string.Format(\"{0,13}\", change);\r\n\r\n        return formatted;\r\n    }\r\n\r\n\r\n    private static IEnumerable<LedgerEntry> sort(LedgerEntry[] entries)\r\n    {\r\n        var neg = entries.Where(e => e.Chg < 0).OrderBy(x => x.Date + \"@\" + x.Desc + \"@\" + x.Chg);\r\n        var post = entries.Where(e => e.Chg >= 0).OrderBy(x => x.Date + \"@\" + x.Desc + \"@\" + x.Chg);\r\n\r\n        var result = new List<LedgerEntry>();\r\n        result.AddRange(neg);\r\n        result.AddRange(post);\r\n\r\n        return result;\r\n    }\r\n\r\n    public static string Format(string currency, string locale, LedgerEntry[] entries)\r\n    {\r\n        var formatted = \"\";\r\n        formatted += PrintHead(locale);\r\n\r\n        var culture = CreateCulture(currency, locale);\r\n\r\n        if (entries.Length > 0)\r\n        {\r\n            var entriesForOutput = sort(entries);\r\n\r\n            for (var i = 0; i < entriesForOutput.Count(); i++)\r\n            {\r\n                formatted += \"\\n\" + PrintEntry(culture, entriesForOutput.Skip(i).First());\r\n            }\r\n        }\r\n\r\n        return formatted;\r\n    }\r\n}\r\n"
  },
  "tests": {
    "LedgerTests.cs": "public class LedgerTests\r\n{\r\n    [Fact]\r\n    public void Empty_ledger()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [];\r\n        var expected =\r\n            \"Date       | Description               | Change       \";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void One_entry()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Buy present\", -1000)\r\n        ];\r\n        var expected =\r\n            \"Date       | Description               | Change       \\n\" +\r\n            \"01/01/2015 | Buy present               |      ($10.00)\";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Credit_and_debit()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-01-02\", \"Get present\", 1000),\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Buy present\", -1000)\r\n        ];\r\n        var expected =\r\n            \"Date       | Description               | Change       \\n\" +\r\n            \"01/01/2015 | Buy present               |      ($10.00)\\n\" +\r\n            \"01/02/2015 | Get present               |       $10.00 \";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Final_order_tie_breaker_is_change()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Something\", 0),\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Something\", -1),\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Something\", 1)\r\n        ];\r\n        var expected =\r\n            \"Date       | Description               | Change       \\n\" +\r\n            \"01/01/2015 | Something                 |       ($0.01)\\n\" +\r\n            \"01/01/2015 | Something                 |        $0.00 \\n\" +\r\n            \"01/01/2015 | Something                 |        $0.01 \";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Overlong_description_is_truncated()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Freude schoner Gotterfunken\", -123456)\r\n        ];\r\n        var expected =\r\n            \"Date       | Description               | Change       \\n\" +\r\n            \"01/01/2015 | Freude schoner Gotterf... |   ($1,234.56)\";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Euros()\r\n    {\r\n        var currency = \"EUR\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Buy present\", -1000)\r\n        ];\r\n        var expected =\r\n            \"Date       | Description               | Change       \\n\" +\r\n            \"01/01/2015 | Buy present               |      (€10.00)\";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Dutch_locale()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"nl-NL\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-03-12\", \"Buy present\", 123456)\r\n        ];\r\n        var expected =\r\n            \"Datum      | Omschrijving              | Verandering  \\n\" +\r\n            \"12-03-2015 | Buy present               |   $ 1.234,56 \";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Dutch_locale_and_euros()\r\n    {\r\n        var currency = \"EUR\";\r\n        var locale = \"nl-NL\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-03-12\", \"Buy present\", 123456)\r\n        ];\r\n        var expected =\r\n            \"Datum      | Omschrijving              | Verandering  \\n\" +\r\n            \"12-03-2015 | Buy present               |   € 1.234,56 \";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Dutch_negative_number_with_3_digits_before_decimal_point()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"nl-NL\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-03-12\", \"Buy present\", -12345)\r\n        ];\r\n        var expected =\r\n            \"Datum      | Omschrijving              | Verandering  \\n\" +\r\n            \"12-03-2015 | Buy present               |    $ -123,45 \";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void American_negative_number_with_3_digits_before_decimal_point()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-03-12\", \"Buy present\", -12345)\r\n        ];\r\n        var expected =\r\n            \"Date       | Description               | Change       \\n\" +\r\n            \"03/12/2015 | Buy present               |     ($123.45)\";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n\r\n    [Fact]\r\n    public void Multiple_entries_on_same_date_ordered_by_description()\r\n    {\r\n        var currency = \"USD\";\r\n        var locale = \"en-US\";\r\n        LedgerEntry[] entries = [\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Get present\", 1000),\r\n            Ledger.CreateEntry(\"2015-01-01\", \"Buy present\", -1000)\r\n        ];\r\n        var expected =\r\n            \"Date       | Description               | Change       \\n\" +\r\n            \"01/01/2015 | Buy present               |      ($10.00)\\n\" +\r\n            \"01/01/2015 | Get present               |       $10.00 \";\r\n        Assert.Equal(expected, Ledger.Format(currency, locale, entries));\r\n    }\r\n}\r\n"
  }
}