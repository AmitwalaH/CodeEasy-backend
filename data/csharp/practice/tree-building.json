{
  "language": "csharp",
  "slug": "tree-building",
  "docs": {
    "instructions": "# Instructions\r\n\r\nRefactor a tree building algorithm.\r\n\r\nSome web-forums have a tree layout, so posts are presented as a tree.\r\nHowever the posts are typically stored in a database as an unsorted set of records.\r\nThus when presenting the posts to the user the tree structure has to be reconstructed.\r\n\r\nYour job will be to refactor a working but slow and ugly piece of code that implements the tree building logic for highly abstracted records.\r\nThe records only contain an ID number and a parent ID number.\r\nThe ID number is always between 0 (inclusive) and the length of the record list (exclusive).\r\nAll records have a parent ID lower than their own ID, except for the root record, which has a parent ID that's equal to its own ID.\r\n\r\nAn example tree:\r\n\r\n```text\r\nroot (ID: 0, parent ID: 0)\r\n|-- child1 (ID: 1, parent ID: 0)\r\n|    |-- grandchild1 (ID: 2, parent ID: 1)\r\n|    +-- grandchild2 (ID: 4, parent ID: 1)\r\n+-- child2 (ID: 3, parent ID: 0)\r\n|    +-- grandchild3 (ID: 6, parent ID: 3)\r\n+-- child3 (ID: 5, parent ID: 0)\r\n```\r\n",
    "instructions_append": "",
    "hints": ""
  },
  "starter_code": {
    "TreeBuilding.cs": "public class TreeBuildingRecord\r\n{\r\n    public int ParentId { get; set; }\r\n    public int RecordId { get; set; }\r\n}\r\n\r\npublic class Tree\r\n{\r\n    public int Id { get; set; }\r\n    public int ParentId { get; set; }\r\n\r\n    public List<Tree> Children { get; set; }\r\n\r\n    public bool IsLeaf => Children.Count == 0;\r\n}\r\n\r\npublic static class TreeBuilder\r\n{\r\n    public static Tree BuildTree(IEnumerable<TreeBuildingRecord> records)\r\n    {\r\n        var ordered = new SortedList<int, TreeBuildingRecord>();\r\n\r\n        foreach (var record in records)\r\n        {\r\n            ordered.Add(record.RecordId, record);\r\n        }\r\n\r\n        records = ordered.Values;\r\n\r\n        var trees = new List<Tree>();\r\n        var previousRecordId = -1;\r\n\r\n        foreach (var record in records)\r\n        {   \r\n            var t = new Tree { Children = new List<Tree>(), Id = record.RecordId, ParentId = record.ParentId };\r\n            trees.Add(t);\r\n\r\n            if ((t.Id == 0 && t.ParentId != 0) ||\r\n                (t.Id != 0 && t.ParentId >= t.Id) ||\r\n                (t.Id != 0 && t.Id != previousRecordId + 1))\r\n            {\r\n                throw new ArgumentException();\r\n            }\r\n\r\n            ++previousRecordId;\r\n        }\r\n        \r\n        if (trees.Count == 0)\r\n        {\r\n            throw new ArgumentException();\r\n        }\r\n\r\n        for (int i = 1; i < trees.Count; i++)\r\n        {\r\n            var t = trees.First(x => x.Id == i);\r\n            var parent = trees.First(x => x.Id == t.ParentId);\r\n            parent.Children.Add(t);\r\n        }\r\n\r\n        var r = trees.First(t => t.Id == 0);\r\n        return r;\r\n    }\r\n}"
  },
  "tests": {
    "TreeBuildingTests.cs": "public class TreeBuildingTests\r\n{\r\n    [Fact]\r\n    public void One_node()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 }\r\n        };\r\n\r\n        var tree = TreeBuilder.BuildTree(records);\r\n\r\n        AssertTreeIsLeaf(tree, id: 0);\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Three_nodes_in_order()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 0 }\r\n        };\r\n\r\n        var tree = TreeBuilder.BuildTree(records);\r\n\r\n        AssertTreeIsBranch(tree, id: 0, childCount: 2);\r\n        AssertTreeIsLeaf(tree.Children[0], id: 1);\r\n        AssertTreeIsLeaf(tree.Children[1], id: 2);\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Three_nodes_in_reverse_order()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 }\r\n        };\r\n\r\n        var tree = TreeBuilder.BuildTree(records);\r\n\r\n        AssertTreeIsBranch(tree, id: 0, childCount: 2);\r\n        AssertTreeIsLeaf(tree.Children[0], id: 1);\r\n        AssertTreeIsLeaf(tree.Children[1], id: 2);\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void More_than_two_children()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 3, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 }\r\n        };\r\n\r\n        var tree = TreeBuilder.BuildTree(records);\r\n\r\n        AssertTreeIsBranch(tree, id: 0, childCount: 3);\r\n        AssertTreeIsLeaf(tree.Children[0], id: 1);\r\n        AssertTreeIsLeaf(tree.Children[1], id: 2);\r\n        AssertTreeIsLeaf(tree.Children[2], id: 3);\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Binary_tree()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 5, ParentId = 1 },\r\n            new TreeBuildingRecord { RecordId = 3, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 4, ParentId = 1 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 6, ParentId = 2 }\r\n        };\r\n\r\n        var tree = TreeBuilder.BuildTree(records);\r\n\r\n        AssertTreeIsBranch(tree, id: 0, childCount: 2);\r\n        AssertTreeIsBranch(tree.Children[0], id: 1, childCount: 2);\r\n        AssertTreeIsBranch(tree.Children[1], id: 2, childCount: 2);\r\n\r\n        AssertTreeIsLeaf(tree.Children[0].Children[0], id: 4);\r\n        AssertTreeIsLeaf(tree.Children[0].Children[1], id: 5);\r\n        AssertTreeIsLeaf(tree.Children[1].Children[0], id: 3);\r\n        AssertTreeIsLeaf(tree.Children[1].Children[1], id: 6);\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Unbalanced_tree()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 5, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 3, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 4, ParentId = 1 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 6, ParentId = 2 }\r\n        };\r\n\r\n        var tree = TreeBuilder.BuildTree(records);\r\n\r\n        AssertTreeIsBranch(tree, id: 0, childCount: 2);\r\n        AssertTreeIsBranch(tree.Children[0], id: 1, childCount: 1);\r\n        AssertTreeIsBranch(tree.Children[1], id: 2, childCount: 3);\r\n\r\n        AssertTreeIsLeaf(tree.Children[0].Children[0], id: 4);\r\n        AssertTreeIsLeaf(tree.Children[1].Children[0], id: 3);\r\n        AssertTreeIsLeaf(tree.Children[1].Children[1], id: 5);\r\n        AssertTreeIsLeaf(tree.Children[1].Children[2], id: 6);\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Empty_input()\r\n    {\r\n        var records = new TreeBuildingRecord[0];\r\n\r\n        Assert.Throws<ArgumentException>(() => TreeBuilder.BuildTree(records));\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Root_node_has_parent()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 1 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 }\r\n        };\r\n\r\n        Assert.Throws<ArgumentException>(() => TreeBuilder.BuildTree(records));\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void No_root_node()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 }\r\n        };\r\n\r\n        Assert.Throws<ArgumentException>(() => TreeBuilder.BuildTree(records));\r\n    }\r\n\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Non_continuous()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 4, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 }\r\n        };\r\n\r\n        Assert.Throws<ArgumentException>(() => TreeBuilder.BuildTree(records));\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Cycle_directly()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 5, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 3, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 4, ParentId = 1 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 6, ParentId = 3 }\r\n        };\r\n\r\n        Assert.Throws<ArgumentException>(() => TreeBuilder.BuildTree(records));\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Cycle_indirectly()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 5, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 3, ParentId = 2 },\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 6 },\r\n            new TreeBuildingRecord { RecordId = 4, ParentId = 1 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 6, ParentId = 3 }\r\n        };\r\n\r\n        Assert.Throws<ArgumentException>(() => TreeBuilder.BuildTree(records));\r\n    }\r\n\r\n    [Fact(Skip = \"Remove this Skip property to run this test\")]\r\n    public void Higher_id_parent_of_lower_id()\r\n    {\r\n        var records = new[]\r\n        {\r\n            new TreeBuildingRecord { RecordId = 0, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 2, ParentId = 0 },\r\n            new TreeBuildingRecord { RecordId = 1, ParentId = 2 }\r\n        };\r\n\r\n        Assert.Throws<ArgumentException>(() => TreeBuilder.BuildTree(records));\r\n    }\r\n\r\n    private static void AssertTreeIsBranch(Tree tree, int id, int childCount)\r\n    {\r\n        Assert.Equal(id, tree.Id);\r\n        Assert.False(tree.IsLeaf);\r\n        Assert.Equal(childCount, tree.Children.Count);\r\n    }\r\n\r\n    private static void AssertTreeIsLeaf(Tree tree, int id)\r\n    {\r\n        Assert.Equal(id, tree.Id);\r\n        Assert.True(tree.IsLeaf);\r\n    }\r\n}"
  }
}